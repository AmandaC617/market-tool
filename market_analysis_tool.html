<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>市場情資與競品分析平台</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        .tab.active { border-color: #4f46e5; background-color: #eef2ff; color: #4338ca; }
        .panel { display: none; }
        .panel.active { display: block; animation: fadeIn 0.5s ease; }
        .locked { opacity: 0.5; pointer-events: none; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #4f46e5; animation: spin 1s ease infinite; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100">

    <header class="bg-white shadow-md">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-gray-800">市場情資與競品分析平台</h1>
            <div id="auth-container">
                <button id="authorize_button" class="hidden bg-indigo-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-indigo-700 transition">使用 Google 帳戶登入</button>
                <div id="user-profile" class="hidden items-center gap-3">
                    <img id="user-avatar" class="w-10 h-10 rounded-full" src="" alt="User Avatar">
                    <span id="user-name" class="font-semibold text-gray-700"></span>
                    <button id="signout_button" class="text-sm text-gray-500 hover:text-gray-800">登出</button>
                </div>
            </div>
        </div>
    </header>
    
    <div id="alert-container" class="sticky top-0 z-50 p-4"></div>

    <main class="container mx-auto px-6 py-8">
        <div id="app-container" class="locked">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                
                <div class="lg:col-span-1 space-y-6">
                    <section id="settings-section" class="bg-white p-6 rounded-lg shadow-lg">
                        <h2 class="text-xl font-bold mb-4">API & 應用程式設定</h2>
                        <div class="space-y-4">
                            <div>
                                <label for="google-api-key" class="block text-sm font-medium text-gray-700">Google API 金鑰</label>
                                <input type="password" id="google-api-key" class="mt-1 w-full p-2 border rounded-md" placeholder="請輸入您的 Google API 金鑰">
                            </div>
                            <div>
                                <label for="search-engine-id" class="block text-sm font-medium text-gray-700">可程式化搜尋引擎 ID (CX)</label>
                                <input type="text" id="search-engine-id" class="mt-1 w-full p-2 border rounded-md" placeholder="請輸入您的 CX ID">
                            </div>
                             <div>
                                <label for="ai-provider" class="block text-sm font-medium text-gray-700">AI 模型提供商</label>
                                <select id="ai-provider" class="mt-1 w-full p-2 border rounded-md">
                                    <option value="gemini">Google Gemini</option>
                                    <option value="monica" disabled>Monica (即將支援)</option>
                                </select>
                            </div>
                            <div>
                                <label for="ai-api-key" class="block text-sm font-medium text-gray-700">AI API 金鑰</label>
                                <input type="password" id="ai-api-key" class="mt-1 w-full p-2 border rounded-md" placeholder="請輸入您的 AI API 金鑰">
                            </div>
                            <button id="save-settings-btn" class="w-full bg-green-600 text-white font-bold py-2 rounded-lg hover:bg-green-700">儲存並啟用設定</button>
                        </div>
                    </section>
                    
                    <section id="analysis-input-section" class="bg-white p-6 rounded-lg shadow-lg locked">
                         <h2 class="text-xl font-bold mb-4">分析目標</h2>
                         <div class="space-y-4">
                             <div>
                                <label for="core-keyword" class="block text-sm font-medium text-gray-700">行業/品牌/產品關鍵字</label>
                                <input type="text" id="core-keyword" class="mt-1 w-full p-2 border rounded-md" placeholder="例如：電動車, SaaS">
                            </div>
                            <div>
                                <label for="target-market" class="block text-sm font-medium text-gray-700">目標市場</label>
                                <select id="target-market" class="mt-1 w-full p-2 border rounded-md">
                                    <option value="us|en|美國">美國 (English)</option>
                                    <option value="jp|ja|日本">日本 (日本語)</option>
                                    <option value="tw|zh-TW|台灣">台灣 (繁體中文)</option>
                                    <option value="de|de|德國">德國 (Deutsch)</option>
                                    <option value="fr|fr|法國">法國 (Français)</option>
                                </select>
                            </div>
                             <div>
                                <label class="block text-sm font-medium text-gray-700">商業模式</label>
                                <div class="mt-2 space-x-4">
                                    <label><input type="radio" name="business-model" value="B2C" checked> B2C</label>
                                    <label><input type="radio" name="business-model" value="B2B"> B2B</label>
                                </div>
                            </div>
                            <button id="start-analysis-btn" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg hover:bg-indigo-700 transition">開始分析</button>
                         </div>
                    </section>
                </div>

                <div class="lg:col-span-2 space-y-6">
                    <div class="bg-white rounded-lg shadow-lg">
                        <div class="flex border-b">
                            <button data-tab="results" class="tab-btn tab active flex-1 p-4 font-semibold">分析結果</button>
                            <button data-tab="history" class="tab-btn tab flex-1 p-4 font-semibold">歷史紀錄</button>
                        </div>

                        <div id="results-panel" class="panel active p-6">
                           <div id="results-content" class="min-h-[400px]">
                                <div id="loading-indicator" class="flex flex-col items-center justify-center h-full">
                                    <p id="loading-status" class="mt-4 text-gray-600 font-medium">請先完成左側設定並點擊開始分析</p>
                                </div>
                               <div id="results-tabs-container" class="hidden">
                                    <div class="flex border-b">
                                        <button class="result-tab-btn tab active flex-1 p-3 font-semibold" data-result-tab="keywords">A. 關鍵字分析</button>
                                        <button class="result-tab-btn tab flex-1 p-3 font-semibold" data-result-tab="competitors">B & C. 競品分析</button>
                                    </div>
                                    <div id="keywords-result-panel" class="result-panel active p-4"></div>
                                    <div id="competitors-result-panel" class="result-panel p-4"></div>
                               </div>
                           </div>
                           <div id="results-actions" class="hidden mt-4 flex gap-4">
                               <button id="save-analysis-btn" class="flex-1 bg-blue-600 text-white font-bold py-2 rounded-lg hover:bg-blue-700">儲存本次分析</button>
                               <button id="export-excel-btn" class="flex-1 bg-gray-700 text-white font-bold py-2 rounded-lg hover:bg-gray-800">匯出為 Excel</button>
                           </div>
                        </div>

                        <div id="history-panel" class="panel p-6 min-h-[400px]">
                            <div id="history-list" class="space-y-4">
                                <p class="text-gray-500">沒有歷史紀錄。</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
<script>
// --- Client-Side Application Logic ---

// --- 1. State and Configuration ---
const state = {
    gapiReady: false,
    gisReady: false,
    tokenClient: null,
    accessToken: null,
    userProfile: null,
    driveFolderId: null,
    apiKeys: {
        google: null,
        searchEngineId: null,
        aiProvider: 'gemini',
        ai: null
    },
    isApiReady: false,
    currentResults: null
};

const CONFIG = {
    CLIENT_ID: "733619441496-5gigdpkv42k84no3q5vvh93ths1e8u29.apps.googleusercontent.com",
    SCOPES: "https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/userinfo.profile https://www.googleapis.com/auth/userinfo.email",
    DRIVE_FOLDER_NAME: "MarketingAnalysisTool_Data"
};

// --- 2. Element References ---
const ui = {
    authorizeButton: document.getElementById('authorize_button'),
    signOutButton: document.getElementById('signout_button'),
    userProfile: document.getElementById('user-profile'),
    appContainer: document.getElementById('app-container'),
    analysisSection: document.getElementById('analysis-input-section'),
    saveSettingsBtn: document.getElementById('save-settings-btn'),
    startAnalysisBtn: document.getElementById('start-analysis-btn'),
    loadingIndicator: document.getElementById('loading-indicator'),
    loadingStatus: document.getElementById('loading-status'),
    resultsContainer: document.getElementById('results-tabs-container'),
    resultsActions: document.getElementById('results-actions'),
    historyList: document.getElementById('history-list'),
};

// --- 3. Initialization ---
window.onload = () => {
    gapi.load('client', gapiLoaded);
    const gisScript = document.createElement('script');
    gisScript.src = 'https://accounts.google.com/gsi/client';
    gisScript.async = true;
    gisScript.defer = true;
    gisScript.onload = gisLoaded;
    document.body.appendChild(gisScript);
    setupEventListeners();
};

function setupEventListeners() {
    ui.authorizeButton.onclick = handleAuthClick;
    ui.signOutButton.onclick = handleSignOutClick;
    ui.saveSettingsBtn.onclick = handleSaveSettings;
    ui.startAnalysisBtn.onclick = startAnalysisWorkflow;
    document.querySelectorAll('.tab-btn').forEach(btn => btn.addEventListener('click', handleTabSwitch));
    document.getElementById('history-list').addEventListener('click', handleHistoryAction);
    document.getElementById('results-actions').addEventListener('click', handleResultAction);
}

// --- 4. Authentication & Authorization ---
function gapiLoaded() { gapi.client.init({}).then(() => { state.gapiReady = true; checkAuthReady(); }); }
function gisLoaded() {
    state.tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CONFIG.CLIENT_ID,
        scope: CONFIG.SCOPES,
        callback: gisInCallback,
    });
    state.gisReady = true;
    checkAuthReady();
}
function checkAuthReady() { if (state.gapiReady && state.gisReady) ui.authorizeButton.classList.remove('hidden'); }

function gisInCallback(resp) {
    if (resp.error) { showAlert('認證錯誤', resp.error, 'error'); return; }
    state.accessToken = resp;
    gapi.client.setToken(state.accessToken);
    handleSuccessfulLogin();
}

function handleAuthClick() {
    if (gapi.client.getToken() === null) {
        state.tokenClient.requestAccessToken({ prompt: 'consent' });
    } else {
        state.tokenClient.requestAccessToken({ prompt: '' });
    }
}

async function handleSuccessfulLogin() {
    ui.authorizeButton.classList.add('hidden');
    ui.userProfile.classList.remove('hidden');
    ui.userProfile.classList.add('flex');
    ui.appContainer.classList.remove('locked');

    const profile = await gapi.client.oauth2.userinfo.get();
    state.userProfile = profile.result;
    document.getElementById('user-avatar').src = state.userProfile.picture;
    document.getElementById('user-name').textContent = state.userProfile.given_name || state.userProfile.name;

    loadSettingsFromLocalStorage();
    await setupGoogleDrive();
    loadAnalysisHistory();
}

function handleSignOutClick() {
    const token = gapi.client.getToken();
    if (token !== null) {
        google.accounts.oauth2.revoke(token.access_token, () => {
            gapi.client.setToken('');
            state.accessToken = null;
            state.userProfile = null;
            ui.userProfile.classList.add('hidden');
            ui.authorizeButton.classList.remove('hidden');
            ui.appContainer.classList.add('locked');
            ui.analysisSection.classList.add('locked');
        });
    }
}

// --- 5. API Settings ---
function handleSaveSettings() {
    const googleApiKey = document.getElementById('google-api-key').value.trim();
    const searchEngineId = document.getElementById('search-engine-id').value.trim();
    const aiProvider = document.getElementById('ai-provider').value;
    const aiApiKey = document.getElementById('ai-api-key').value.trim();
    
    if (!googleApiKey || !searchEngineId || !aiApiKey) {
        showAlert('資訊不完整', '請填寫所有 API 金鑰與 ID 欄位。', 'warning');
        return;
    }
    state.apiKeys = { google: googleApiKey, searchEngineId: searchEngineId, aiProvider: aiProvider, ai: aiApiKey };
    localStorage.setItem('marketingToolApiKeys', btoa(JSON.stringify(state.apiKeys)));
    state.isApiReady = true;
    ui.analysisSection.classList.remove('locked');
    showAlert('設定已儲存', 'API 已設定完成並啟用。', 'success');
}

function loadSettingsFromLocalStorage() {
    const savedKeys = localStorage.getItem('marketingToolApiKeys');
    if (savedKeys) {
        try {
            const decodedKeys = JSON.parse(atob(savedKeys));
            state.apiKeys = decodedKeys;
            state.isApiReady = true;
            document.getElementById('google-api-key').value = state.apiKeys.google || '';
            document.getElementById('search-engine-id').value = state.apiKeys.searchEngineId || '';
            document.getElementById('ai-provider').value = state.apiKeys.aiProvider || 'gemini';
            document.getElementById('ai-api-key').value = state.apiKeys.ai || '';
            ui.analysisSection.classList.remove('locked');
        } catch (e) {
            console.error("無法解析已儲存的 API 金鑰:", e);
        }
    }
}

// --- 6. Google Drive Integration ---
async function setupGoogleDrive() {
    await gapi.client.load('drive', 'v3');
    const response = await gapi.client.drive.files.list({
        q: `name='${CONFIG.DRIVE_FOLDER_NAME}' and mimeType='application/vnd.google-apps.folder' and trashed=false`,
        fields: 'files(id)'
    });
    if (response.result.files && response.result.files.length > 0) {
        state.driveFolderId = response.result.files[0].id;
    } else {
        const fileMetadata = { 'name': CONFIG.DRIVE_FOLDER_NAME, 'mimeType': 'application/vnd.google-apps.folder' };
        const createResponse = await gapi.client.drive.files.create({ resource: fileMetadata, fields: 'id' });
        state.driveFolderId = createResponse.result.id;
    }
}

// --- 7. Main Analysis Workflow ---
async function startAnalysisWorkflow() {
    if (!state.isApiReady) { showAlert('API 尚未就緒', '請先儲存您的 API 設定。', 'error'); return; }
    const coreKeyword = document.getElementById('core-keyword').value.trim();
    if (!coreKeyword) { showAlert('需要輸入', '請輸入行業、品牌或產品關鍵字。', 'warning'); return; }

    ui.loadingIndicator.style.display = 'flex';
    ui.loadingStatus.textContent = '準備中...';
    ui.resultsContainer.classList.add('hidden');
    
    try {
        ui.loadingStatus.textContent = '步驟 1/3: 正在生成行業關鍵字...';
        const keywordsResponse = await getAiKeywordAnalysis();
        state.currentResults = { keywords: keywordsResponse.keywords || [] };
        renderPartialResults('keywords');

        ui.loadingStatus.textContent = '步驟 2/3: 正在搜尋競爭對手...';
        const searchResults = await performGoogleSearch(state.currentResults.keywords);
        
        ui.loadingStatus.textContent = '步驟 3/3: 正在分析競爭對手資訊...';
        const competitorsResponse = await getAiCompetitorAnalysis(searchResults);
        state.currentResults.competitors = competitorsResponse.competitors || [];

        renderPartialResults('competitors');
        showAlert('分析完成', '所有報告皆已生成完畢。', 'success');

    } catch (error) {
        console.error("分析失敗:", error);
        showAlert('分析失敗', `發生錯誤: ${error.message}`, 'error');
    } finally {
        ui.loadingIndicator.style.display = 'none';
    }
}

// --- 8. API Call Functions ---
async function getAiKeywordAnalysis() {
    const marketInfo = document.getElementById('target-market').value.split('|');
    const prompt = `你是一位專精於 ${marketInfo[2]} 市場的資深SEO與市場分析專家。請針對以下條件，生成一份詳細的關鍵字分析報告：- 核心主題: "${document.getElementById('core-keyword').value}" - 商業模式: "${document.querySelector('input[name="business-model"]:checked').value}" - 目標語言: "${marketInfo[1]}" 請提供 50 個最相關的關鍵字，盡可能涵蓋短尾、中尾和長尾關鍵字。對於每個關鍵字，請評估其「搜尋量級」（高、中、低）和「關鍵字類型」（例如：品牌字、產品字、比較字、問題字、資訊字）。請嚴格以 JSON 格式返回，不要包含任何 json 標籤或註解，格式如下：{ "keywords": [{ "keyword": "...", "volume": "高", "type": "產品字" }, ...] }`;
    return safeJsonParse(await callGeminiAPI(prompt));
}

async function performGoogleSearch(keywords) {
    if (!keywords || keywords.length === 0) return [];
    const query = keywords.filter(k => k.volume === '高').slice(0, 3).map(k => `"${k.keyword}"`).join(' OR ');
    if (!query) return [];
    const marketInfo = document.getElementById('target-market').value.split('|');
    const response = await gapi.client.request({
        'path': `https://customsearch.googleapis.com/customsearch/v1`,
        'params': { 'key': state.apiKeys.google, 'cx': state.apiKeys.searchEngineId, 'q': query, 'cr': `country${marketInfo[0].toUpperCase()}` }
    });
    return response.result.items || [];
}

async function getAiCompetitorAnalysis(searchResults) {
    if (searchResults.length === 0) return { competitors: [] };
    const context = searchResults.slice(0, 10).map(item => `Title: ${item.title}\nURL: ${item.link}\nSnippet: ${item.snippet}`).join('\n\n');
    const prompt = `你是一位市場情報分析師。以下是針對 "${document.getElementById('core-keyword').value}" 的 Google 搜尋結果。請從中分析並識別出 5 個最主要的競爭對手。對於每個競爭對手，完成以下任務：1. 識別其官方品牌名稱和主要網站 URL。2. 根據其網站摘要，用繁體中文總結其核心業務（不超過 30 字）。3. 在 LinkedIn 上尋找其官方公司頁面 URL。如果找不到，請返回 "N/A"。4. 根據其業務性質，將其分類為以下類型之一：[SaaS, 硬體製造, 顧問服務, 零售電商, 代理商, 內容平台]。請嚴格以 JSON 格式返回，不要包含任何 json 標籤或註解，格式如下：{ "competitors": [{ "brandName": "...", "websiteUrl": "...", "summary": "...", "linkedinUrl": "...", "companyType": "SaaS" }, ...] } 搜尋結果上下文:\n${context}`;
    return safeJsonParse(await callGeminiAPI(prompt));
}

async function callGeminiAPI(prompt) {
    const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${state.apiKeys.ai}`;
    const response = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
    });
    if (!response.ok) {
        const errorBody = await response.json();
        throw new Error(`Gemini API Error: ${errorBody.error.message}`);
    }
    const data = await response.json();
    if (!data.candidates || !data.candidates[0].content.parts[0].text) {
        throw new Error("Gemini API 回應格式無效。");
    }
    return data.candidates[0].content.parts[0].text;
}

// --- 9. Rendering, History & Export ---
function renderPartialResults(type) {
    ui.resultsContainer.classList.remove('hidden');
    if (type === 'keywords') {
        const panel = document.getElementById('keywords-result-panel');
        const groupedKeywords = (state.currentResults.keywords || []).reduce((acc, kw) => {
            if (!acc[kw.type]) acc[kw.type] = [];
            acc[kw.type].push(kw);
            return acc;
        }, {});
        
        const volumeColorMap = { '高': 'bg-red-200 text-red-800', '中': 'bg-yellow-200 text-yellow-800', '低': 'bg-green-200 text-green-800' };

        panel.innerHTML = Object.entries(groupedKeywords).map(([type, kws]) => `
            <div class="mb-6">
                <h4 class="font-bold text-lg mb-3 text-gray-700">${type}</h4>
                <div class="flex flex-wrap gap-2">
                    ${kws.map(kw => `<span class="px-3 py-1 rounded-full text-sm font-medium ${volumeColorMap[kw.volume] || 'bg-gray-200'}">${kw.keyword}</span>`).join('')}
                </div>
            </div>
        `).join('') || '<p>無關鍵字資料</p>';
    }
    
    if (type === 'competitors') {
        const panel = document.getElementById('competitors-result-panel');
        panel.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            ${(state.currentResults.competitors || []).map(c => `
                <div class="p-4 border rounded-lg bg-white shadow-sm hover:shadow-md transition-shadow">
                    <h4 class="font-bold text-xl text-indigo-700">${c.brandName}</h4>
                    <p class="text-sm text-gray-500 mt-1 mb-3">${c.companyType}</p>
                    <p class="text-gray-700 mb-4">${c.summary}</p>
                    <div class="mt-auto flex gap-4 border-t pt-3">
                        <a href="${c.websiteUrl}" target="_blank" class="text-blue-600 hover:underline font-medium">官方網站</a>
                        ${c.linkedinUrl !== 'N/A' ? `<a href="${c.linkedinUrl}" target="_blank" class="text-blue-600 hover:underline font-medium">LinkedIn</a>` : '<span class="text-gray-400">無 LinkedIn</span>'}
                    </div>
                </div>
            `).join('')}
        </div>` || '<p>無競爭對手資料</p>';
        
        // Hide individual B and C tabs, as they are now combined.
        document.querySelector('.result-tab-btn[data-result-tab="competitors"]').textContent = 'B & C. 競品分析';
        document.querySelector('.result-tab-btn[data-result-tab="linkedin"]')?.remove();
        
        ui.resultsActions.classList.remove('hidden');
    }
}


async function saveAnalysisToDrive() {
    if (!state.currentResults || !state.driveFolderId) return;
    const metadata = { name: `${document.getElementById('core-keyword').value.trim()}_${new Date().toISOString()}.json`, mimeType: 'application/json', parents: [state.driveFolderId] };
    const boundary = 'foo_bar_baz';
    const multipartRequestBody = `--${boundary}\r\nContent-Type: application/json; charset=UTF-8\r\n\r\n${JSON.stringify(metadata)}\r\n--${boundary}\r\nContent-Type: application/json\r\n\r\n${JSON.stringify({ inputs: { keyword: document.getElementById('core-keyword').value.trim(), market: document.getElementById('target-market').value, model: document.querySelector('input[name="business-model"]:checked').value }, results: state.currentResults })}\r\n--${boundary}--`;
    try {
        await gapi.client.request({ path: '/upload/drive/v3/files', method: 'POST', params: { uploadType: 'multipart' }, headers: { 'Content-Type': 'multipart/related; boundary="' + boundary + '"' }, body: multipartRequestBody });
        showAlert('儲存成功', '分析報告已儲存至您的 Google Drive。', 'success');
        loadAnalysisHistory();
    } catch (e) {
        showAlert('儲存失敗', '無法將報告儲存至 Google Drive。', 'error');
    }
}

async function loadAnalysisHistory() {
    if (!state.driveFolderId) return;
    const response = await gapi.client.drive.files.list({ q: `'${state.driveFolderId}' in parents and trashed=false`, fields: 'files(id, name, createdTime)', orderBy: 'createdTime desc' });
    const files = response.result.files;
    ui.historyList.innerHTML = '';
    if (files && files.length > 0) {
        files.forEach(file => {
            const fileEl = document.createElement('div');
            fileEl.className = 'border p-3 rounded-lg flex justify-between items-center';
            fileEl.innerHTML = `<div><p class="font-semibold">${file.name.replace('.json', '')}</p><p class="text-sm text-gray-500">儲存於: ${new Date(file.createdTime).toLocaleDateString()}</p></div><div><button data-id="${file.id}" class="load-history-btn text-sm bg-gray-200 px-3 py-1 rounded hover:bg-gray-300">載入</button></div>`;
            ui.historyList.appendChild(fileEl);
        });
    } else {
        ui.historyList.innerHTML = '<p class="text-gray-500">沒有歷史紀錄。</p>';
    }
}

async function handleHistoryAction(e) {
    if (e.target.classList.contains('load-history-btn')) {
        const fileId = e.target.dataset.id;
        try {
            const response = await gapi.client.drive.files.get({ fileId: fileId, alt: 'media' });
            state.currentResults = response.result.results;
            renderPartialResults('keywords');
            renderPartialResults('competitors');
            document.querySelector('.tab-btn[data-tab="results"]').click();
            showAlert('紀錄已載入', '成功從歷史紀錄載入分析報告。', 'info');
        } catch (error) {
            showAlert('載入失敗', '無法載入所選的歷史紀錄。', 'error');
        }
    }
}

function handleResultAction(e) {
    if (e.target.id === 'save-analysis-btn') saveAnalysisToDrive();
    else if (e.target.id === 'export-excel-btn') exportToExcel();
}

function handleTabSwitch(e) {
    const target = e.target.closest('.tab-btn');
    if (target) {
        if (target.closest('#results-tabs-container')) {
            const tab = target.dataset.resultTab;
            document.querySelectorAll('.result-tab-btn').forEach(b => b.classList.remove('active'));
            target.classList.add('active');
            document.querySelectorAll('.result-panel').forEach(p => p.classList.remove('active'));
            document.getElementById(`${tab}-result-panel`).classList.add('active');
        } else {
            const tab = target.dataset.tab;
            document.querySelectorAll('.tab-btn:not(.result-tab-btn)').forEach(b => b.classList.remove('active'));
            target.classList.add('active');
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            document.getElementById(`${tab}-panel`).classList.add('active');
        }
    }
}

function exportToExcel() {
    if (!state.currentResults) return;
    const wb = XLSX.utils.book_new();
    const keywordsSheet = XLSX.utils.json_to_sheet(state.currentResults.keywords);
    XLSX.utils.book_append_sheet(wb, keywordsSheet, "A_關鍵字分析");

    const competitorsSheetData = state.currentResults.competitors.map(c => ({ '品牌名稱': c.brandName, '業務摘要': c.summary, '網站': c.websiteUrl, '公司類型': c.companyType, 'LinkedIn': c.linkedinUrl }));
    const competitorsSheet = XLSX.utils.json_to_sheet(competitorsSheetData);
    XLSX.utils.book_append_sheet(wb, competitorsSheet, "B_C_競品綜合分析");
    
    XLSX.writeFile(wb, `${document.getElementById('core-keyword').value.trim()}_Analysis.xlsx`);
}

function showAlert(title, message, type = 'info') {
    const colors = { info: 'bg-blue-100 border-blue-500 text-blue-700', success: 'bg-green-100 border-green-500 text-green-700', warning: 'bg-yellow-100 border-yellow-500 text-yellow-700', error: 'bg-red-100 border-red-500 text-red-700' };
    const alertEl = document.createElement('div');
    alertEl.className = `p-4 mb-4 rounded-md shadow-lg border-l-4 ${colors[type]}`;
    alertEl.innerHTML = `<div class="flex"><div class="ml-3"><p class="font-bold">${title}</p><p class="text-sm">${message}</p></div><button class="ml-auto -mx-1.5 -my-1.5 p-1.5 rounded-lg inline-flex h-8 w-8" onclick="this.parentElement.parentElement.remove()">×</button></div>`;
    document.getElementById('alert-container').prepend(alertEl);
    setTimeout(() => alertEl.remove(), 6000);
}

function safeJsonParse(str) {
    try {
        const cleanStr = str.replace(/```json/g, '').replace(/```/g, '').trim();
        return JSON.parse(cleanStr);
    } catch (e) {
        console.error("JSON 解析失敗:", str);
        throw new Error("AI 回應的資料格式錯誤，無法解析。");
    }
}

</script>
</body>
</html>
