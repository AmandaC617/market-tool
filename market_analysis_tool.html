<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>市場情資與競品分析平台</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://accounts.google.com/gsi/client"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            techbg: '#181D27',
            techpanel: '#22283A',
            techaccent: '#2EE9E4',
            techprimary: '#3762F0',
            techsecondary: '#7D5FFF'
          },
          fontFamily: {
            'tech': ['"Segoe UI"', 'Roboto', 'Arial', 'sans-serif']
          }
        }
      }
    }
  </script>
  <style>
    body { font-family: "Segoe UI", Roboto, Arial, sans-serif; }
    .tab.active { border-color: #2EE9E4; background-color: #181D27; color: #2EE9E4; }
    .panel { display: none; }
    .panel.active { display: block; animation: fadeIn 0.5s ease; }
    .locked { opacity: 0.5; pointer-events: none; }
    .spinner { border: 4px solid rgba(59,130,246,.2); width: 36px; height: 36px; border-radius: 50%; border-left-color: #2EE9E4; animation: spin 1s ease infinite; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes spin { to { transform: rotate(360deg); } }
    th, td {white-space:nowrap;}
    .overflow-x-auto {overflow-x:auto;}
  </style>
</head>
<body class="bg-techbg font-tech text-gray-100 min-h-screen">
  <header class="bg-techpanel shadow-lg">
    <div class="container mx-auto px-6 py-4 flex justify-between items-center">
      <h1 class="text-3xl font-extrabold tracking-wide text-techaccent flex items-center gap-2">
        <svg class="w-8 h-8 text-techprimary inline-block" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 3v2m0 14v2m9-9h-2M5 12H3m15.364-7.364l-1.414 1.414M6.05 17.95l-1.414 1.414m12.728 0l1.414-1.414M6.05 6.05L4.636 4.636" stroke-linecap="round" stroke-linejoin="round"/></svg>
        市場情資與競品分析平台
      </h1>
      <div id="auth-container">
        <button id="authorize_button" class="hidden bg-gradient-to-tr from-techprimary to-techaccent hover:from-techsecondary hover:to-techaccent font-bold text-white px-5 py-2 rounded-lg shadow-lg tracking-wide transition-all duration-200">使用 Google 帳戶登入</button>
        <div id="user-profile" class="hidden items-center gap-3">
          <img id="user-avatar" class="w-10 h-10 rounded-full" src="" alt="User Avatar">
          <span id="user-name" class="font-semibold text-gray-200"></span>
          <button id="signout_button" class="text-sm text-gray-400 hover:text-techaccent">登出</button>
        </div>
      </div>
    </div>
  </header>
  <div id="alert-container" class="sticky top-0 z-50 p-4"></div>
  <main class="container mx-auto px-6 py-8">
    <div id="app-container" class="locked">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <div class="lg:col-span-1 space-y-6">
          <section id="settings-section" class="bg-techpanel rounded-xl shadow-2xl border border-techprimary/20 p-6">
            <h2 class="text-xl font-bold mb-4 text-techaccent">API & 應用程式設定</h2>
            <div class="space-y-4">
              <div>
                <label for="drive-folder-name" class="block text-sm font-medium text-techaccent">Google Drive 資料夾名稱</label>
                <input type="text" id="drive-folder-name" class="mt-1 w-full px-4 py-2 rounded-lg bg-techbg border border-techprimary/20 focus:outline-none focus:ring-2 focus:ring-techprimary text-techaccent placeholder:text-techprimary/50 transition" placeholder="例如：Project_SaaS_Analysis">
              </div>
              <div class="border-b border-techprimary/30 my-4"></div>
              <div>
                <label for="google-api-key" class="block text-sm font-medium text-techaccent">Google API 金鑰</label>
                <input type="password" id="google-api-key" class="mt-1 w-full px-4 py-2 rounded-lg bg-techbg border border-techprimary/20 focus:outline-none focus:ring-2 focus:ring-techprimary text-techaccent placeholder:text-techprimary/50 transition" placeholder="請輸入您的 Google API 金鑰">
              </div>
              <div>
                <label for="search-engine-id" class="block text-sm font-medium text-techaccent">可程式化搜尋引擎 ID (CX)</label>
                <input type="text" id="search-engine-id" class="mt-1 w-full px-4 py-2 rounded-lg bg-techbg border border-techprimary/20 focus:outline-none focus:ring-2 focus:ring-techprimary text-techaccent placeholder:text-techprimary/50 transition" placeholder="請輸入您的 CX ID">
              </div>
              <div>
                <label for="ai-gemini-key" class="block text-sm font-medium text-techaccent">Gemini AI API 金鑰</label>
                <input type="password" id="ai-gemini-key" class="mt-1 w-full px-4 py-2 rounded-lg bg-techbg border border-techprimary/20 focus:outline-none focus:ring-2 focus:ring-techprimary text-techaccent placeholder:text-techprimary/50 transition" placeholder="請輸入您的 Gemini API 金鑰">
              </div>
              <div>
                <label for="ai-monica-key" class="block text-sm font-medium text-techaccent">Monica AI API 金鑰</label>
                <input type="password" id="ai-monica-key" class="mt-1 w-full px-4 py-2 rounded-lg bg-techbg border border-techprimary/20 focus:outline-none focus:ring-2 focus:ring-techprimary text-techaccent placeholder:text-techprimary/50 transition" placeholder="請輸入您的 Monica API 金鑰">
              </div>
              <button id="save-settings-btn" class="w-full bg-gradient-to-tr from-techprimary to-techaccent hover:from-techsecondary hover:to-techaccent font-bold text-white px-5 py-2 rounded-lg shadow-lg tracking-wide transition-all duration-200">儲存並啟用設定</button>
            </div>
            <div>
 <div>
  <label for="topic-setting" class="block text-sm font-medium text-techaccent">分析主題</label>
  <input type="text" id="topic-setting" class="..." placeholder="請輸入分析主題（選填）">
</div>
          </section>
          <section id="analysis-input-section" class="bg-techpanel rounded-xl shadow-2xl border border-techprimary/20 p-6 locked">
            <h2 class="text-xl font-bold mb-4 text-techaccent">分析目標</h2>
            <div class="space-y-4">
             <div>
  <label for="topic" class="block text-sm font-medium text-techaccent">分析主題</label>
  <input type="text" id="topic" class="mt-1 w-full px-4 py-2 rounded-lg bg-techbg border border-techprimary/20 focus:outline-none focus:ring-2 focus:ring-techprimary text-techaccent" placeholder="請輸入分析主題（選填）">
</div>
              <div>
                <label for="country" class="block text-sm font-medium text-techaccent">國家/地區</label>
                <select id="country" class="mt-1 w-full px-4 py-2 rounded-lg bg-techbg border border-techprimary/20 focus:outline-none focus:ring-2 focus:ring-techprimary text-techaccent">
                  <option value="TW">台灣</option>
                  <option value="CN">中國</option>
                  <option value="HK">香港</option>
                  <option value="JP">日本</option>
                  <option value="KR">韓國</option>
                  <option value="US">美國</option>
                  <option value="SG">新加坡</option>
                  <option value="DE">德國</option>
                  <option value="GB">英國</option>
                  <option value="FR">法國</option>
                  <option value="TH">泰國</option>
                  <!-- ... 可擴充 -->
                </select>
              </div>
              <div>
                <label for="language" class="block text-sm font-medium text-techaccent">語言</label>
                <select id="language" class="mt-1 w-full px-4 py-2 rounded-lg bg-techbg border border-techprimary/20 focus:outline-none focus:ring-2 focus:ring-techprimary text-techaccent">
                  <option value="zh-TW">繁體中文</option>
                  <option value="zh-CN">簡體中文</option>
                  <option value="en">英文</option>
                  <option value="ja">日文</option>
                  <option value="ko">韓文</option>
                  <option value="th">泰文</option>
                  <option value="de">德文</option>
                  <option value="fr">法文</option>
                </select>
              </div>
              <div>
                <label for="industry" class="block text-sm font-medium text-techaccent">產業名稱</label>
                <input type="text" id="industry" class="mt-1 w-full px-4 py-2 rounded-lg bg-techbg border border-techprimary/20 focus:outline-none focus:ring-2 focus:ring-techprimary text-techaccent placeholder:text-techprimary/50 transition" placeholder="如：電子商務">
              </div>
              <div>
                <label for="sector" class="block text-sm font-medium text-techaccent">行業名稱</label>
                <input type="text" id="sector" class="mt-1 w-full px-4 py-2 rounded-lg bg-techbg border border-techprimary/20 focus:outline-none focus:ring-2 focus:ring-techprimary text-techaccent placeholder:text-techprimary/50 transition" placeholder="如：零售">
              </div>
              <div>
                <label for="product" class="block text-sm font-medium text-techaccent">產品名稱</label>
                <input type="text" id="product" class="mt-1 w-full px-4 py-2 rounded-lg bg-techbg border border-techprimary/20 focus:outline-none focus:ring-2 focus:ring-techprimary text-techaccent placeholder:text-techprimary/50 transition" placeholder="如：CRM軟體">
              </div>
              <div>
                <label for="company" class="block text-sm font-medium text-techaccent">公司名稱</label>
                <input type="text" id="company" class="mt-1 w-full px-4 py-2 rounded-lg bg-techbg border border-techprimary/20 focus:outline-none focus:ring-2 focus:ring-techprimary text-techaccent placeholder:text-techprimary/50 transition" placeholder="如：Salesforce">
              </div>
              <div>
                <label class="block text-sm font-medium text-techaccent">商業模式</label>
                <div class="mt-2 space-x-4">
                  <label><input type="radio" name="business-model" value="B2C" checked> B2C</label>
                  <label><input type="radio" name="business-model" value="B2B"> B2B</label>
                  <label><input type="radio" name="business-model" value="B2B2C"> B2B2C</label>
                </div>
              </div>
              <div>
                <label for="target-audience" class="block text-sm font-medium text-techaccent">目標市場人群</label>
                <input type="text" id="target-audience" class="mt-1 w-full px-4 py-2 rounded-lg bg-techbg border border-techprimary/20 focus:outline-none focus:ring-2 focus:ring-techprimary text-techaccent placeholder:text-techprimary/50 transition" placeholder="如：台灣中小企業決策者">
              </div>
              <button id="start-analysis-btn" class="w-full bg-gradient-to-tr from-techprimary to-techaccent hover:from-techsecondary hover:to-techaccent font-bold text-white px-5 py-3 rounded-lg shadow-lg tracking-wide transition-all duration-200">開始分析</button>
            </div>
          </section>
          <section id="competitor-select-panel" class="bg-gradient-to-br from-techpanel via-techbg to-techpanel border border-techprimary/30 rounded-xl p-6 shadow-lg mb-4 hidden">
            <div class="mb-2 font-bold text-techprimary text-lg flex items-center gap-2">
              <svg class="w-5 h-5 text-techaccent" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M5 13l4 4L19 7" stroke-linecap="round" stroke-linejoin="round"/></svg>
              請勾選要深入分析的競爭對手
            </div>
            <label class="inline-flex items-center mb-2 mr-6">
              <input type="checkbox" id="select-all-competitors" class="mr-2 accent-techaccent scale-125">
              <span>全選</span>
            </label>
            <div id="competitor-checkbox-list" class="mb-2"></div>
            <button id="analyze-selected-btn" class="mt-3 bg-gradient-to-r from-techprimary to-techaccent hover:from-techaccent hover:to-techprimary text-white px-4 py-2 rounded shadow font-bold">進行分析</button>
          </section>
        </div>
        <div class="lg:col-span-2 space-y-6">
          <div class="bg-techpanel rounded-xl shadow-2xl border border-techprimary/20">
            <div class="flex border-b border-techprimary/20">
              <button data-tab="results" class="tab-btn tab active flex-1 p-4 font-semibold bg-techpanel text-gray-200 border-b-2 border-transparent hover:border-techaccent hover:text-techaccent transition-all">分析結果</button>
              <button data-tab="history" class="tab-btn tab flex-1 p-4 font-semibold bg-techpanel text-gray-200 border-b-2 border-transparent hover:border-techaccent hover:text-techaccent transition-all">歷史紀錄</button>
            </div>
            <div id="results-panel" class="panel active p-6">
              <div id="results-content" class="min-h-[400px]">
                <div id="loading-indicator" class="flex flex-col items-center justify-center h-full">
                  <div class="spinner hidden"></div>
                  <p id="loading-status" class="mt-4 text-techaccent font-medium">請先完成左側設定並點擊開始分析</p>
                </div>
                <div id="results-tabs-container" class="hidden">
                  <div class="flex border-b border-techprimary/20">
                    <button class="result-tab-btn tab active flex-1 p-3 font-semibold" data-result-tab="keywords">A. 關鍵字分析</button>
                    <button class="result-tab-btn tab flex-1 p-3 font-semibold" data-result-tab="competitors">B. 競爭對手網站</button>
                    <button class="result-tab-btn tab flex-1 p-3 font-semibold" data-result-tab="linkedin">C. LinkedIn 分析</button>
                  </div>
                  <div id="keywords-result-panel" class="result-panel active p-4 overflow-x-auto"></div>
                   <div id="keywords-list"></div>
                  <div id="competitors-result-panel" class="result-panel p-4 overflow-x-auto"></div>
                  <div id="linkedin-result-panel" class="result-panel p-4 overflow-x-auto"></div>
                </div>
              </div>
              <div id="results-actions" class="hidden mt-4 flex gap-4">
                <button id="save-analysis-btn" class="flex-1 bg-gradient-to-tr from-techprimary to-techaccent hover:from-techsecondary hover:to-techaccent font-bold text-white px-4 py-2 rounded-lg shadow-lg tracking-wide transition-all duration-200">儲存本次分析</button>
                <button id="export-excel-btn" class="flex-1 bg-gradient-to-tr from-gray-600 to-gray-800 hover:from-techsecondary hover:to-gray-800 font-bold text-white px-4 py-2 rounded-lg shadow-lg tracking-wide transition-all duration-200">匯出為 Excel</button>
              </div>
            </div>
            <div id="history-panel" class="panel p-6 min-h-[400px]">
              <div id="history-list" class="space-y-4">
                <p class="text-gray-500">沒有歷史紀錄。</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
<script>
// ------ 狀態管理與 UI 元件 ------
const state = {
  gapiReady: false, gisReady: false, tokenClient: null, accessToken: null, userProfile: null, driveFolderId: null,
  apiKeys: { google: null, searchEngineId: null, gemini: null, monica: null, driveFolderName: 'MarketingAnalysisTool_Data' },
  isApiReady: false, currentResults: null, initialCompetitorNames: []
};
const ui = {
  authorizeButton: document.getElementById('authorize_button'),
  signOutButton: document.getElementById('signout_button'),
  userProfile: document.getElementById('user-profile'),
  appContainer: document.getElementById('app-container'),
  analysisSection: document.getElementById('analysis-input-section'),
  saveSettingsBtn: document.getElementById('save-settings-btn'),
  startAnalysisBtn: document.getElementById('start-analysis-btn'),
  loadingIndicator: document.getElementById('loading-indicator'),
  spinner: document.querySelector('.spinner'),
  loadingStatus: document.getElementById('loading-status'),
  resultsContainer: document.getElementById('results-tabs-container'),
  resultsActions: document.getElementById('results-actions'),
  historyList: document.getElementById('history-list'),
  competitorSelectPanel: document.getElementById('competitor-select-panel'),
  competitorCheckboxList: document.getElementById('competitor-checkbox-list'),
  selectAllCompetitors: document.getElementById('select-all-competitors'),
  analyzeSelectedBtn: document.getElementById('analyze-selected-btn')
};

window.onload = () => {
  gapi.load('client', () => { state.gapiReady = true; checkAuthReady(); });
  const gisScript = document.createElement('script');
  gisScript.src = 'https://accounts.google.com/gsi/client';
  gisScript.async = true; gisScript.defer = true;
  gisScript.onload = () => {
    state.tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: "733619441496-5gigdpkv42k84no3q5vvh93ths1e8u29.apps.googleusercontent.com",
      scope: "https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/userinfo.profile https://www.googleapis.com/auth/userinfo.email",
      callback: gisInCallback,
    });
    state.gisReady = true;
    checkAuthReady();
  };
  document.body.appendChild(gisScript);
  setupEventListeners();
};
function setupEventListeners() {
  ui.authorizeButton.onclick = handleAuthClick;
  ui.signOutButton.onclick = handleSignOutClick;
  ui.saveSettingsBtn.onclick = handleSaveSettings;
  ui.startAnalysisBtn.onclick = startInitialAnalysis;
  document.querySelectorAll('.tab-btn').forEach(btn => btn.addEventListener('click', handleTabSwitch));
  document.getElementById('history-list').addEventListener('click', handleHistoryAction);
  document.getElementById('results-actions').addEventListener('click', handleResultAction);
  document.getElementById('results-tabs-container').addEventListener('click', handleTabSwitch);
  ui.selectAllCompetitors.addEventListener('change', function(){
    const all = this.checked;
    document.querySelectorAll('.competitor-checkbox').forEach(cb => cb.checked = all);
  });
  ui.analyzeSelectedBtn.addEventListener('click', analyzeCheckedCompetitors);
  ui.saveAnalysisBtn.onclick = saveAnalysisToDrive;
}
function handleHistoryAction(event) {
  // 你可以根據需求補功能，暫時空白也可以
}
function handleTabSwitch(event) {
  // 這是一個簡單範例，確保不會再報錯
  // 你可以根據需求做分頁切換
  const btn = event.target.closest('.tab-btn');
  if (!btn) return;
  document.querySelectorAll('.tab-btn').forEach(tab => tab.classList.remove('active'));
  btn.classList.add('active');
  const tab = btn.getAttribute('data-tab');
  document.querySelectorAll('.panel').forEach(panel => panel.classList.remove('active'));
  const activePanel = document.getElementById(tab + '-panel');
  if (activePanel) activePanel.classList.add('active');
}
function checkAuthReady() {
  // 只要登入和API設定齊全，就解鎖分析欄位
  if (state.gapiReady && state.gisReady) {
    if (!state.accessToken) {
      ui.authorizeButton.classList.remove('hidden');
      ui.userProfile.classList.add('hidden');
      ui.appContainer.classList.add('locked');
      ui.analysisSection.classList.add('locked');
    } else {
      ui.authorizeButton.classList.add('hidden');
      ui.userProfile.classList.remove('hidden');
      ui.appContainer.classList.remove('locked');
      if (state.isApiReady) {
        ui.analysisSection.classList.remove('locked');
      } else {
        ui.analysisSection.classList.add('locked');
      }
    }
  }
}
function showAlert(title, message, type = 'info') {
  const alertContainer = document.getElementById('alert-container');
  let color = '';
  switch(type) {
    case 'success': color = 'bg-green-600'; break;
    case 'error': color = 'bg-red-600'; break;
    case 'warning': color = 'bg-yellow-600 text-black'; break;
    default: color = 'bg-blue-600'; break;
  }
  const alertDiv = document.createElement('div');
  alertDiv.className = `rounded-lg shadow-lg px-5 py-3 mb-2 font-bold ${color}`;
  alertDiv.innerHTML = `<strong>${title}</strong> <span class="font-normal">${message}</span>`;
  alertContainer.appendChild(alertDiv);
  setTimeout(() => {
    alertDiv.remove();
  }, 2600);
}
function handleSaveSettings() {
  state.apiKeys.google = document.getElementById('google-api-key').value.trim();
  state.apiKeys.searchEngineId = document.getElementById('search-engine-id').value.trim();
  state.apiKeys.gemini = document.getElementById('ai-gemini-key').value.trim();
  state.apiKeys.monica = document.getElementById('ai-monica-key').value.trim();
  state.apiKeys.driveFolderName = document.getElementById('drive-folder-name').value.trim();

  if (
    state.apiKeys.google ||
    state.apiKeys.searchEngineId ||
    state.apiKeys.gemini ||
    state.apiKeys.monica
  ) {
    state.isApiReady = true;
    showAlert('設定已儲存', 'API設定已更新，可以進行分析。', 'success');
  } else {
    state.isApiReady = false;
    showAlert('設定不完整', '請至少填寫一組API金鑰。', 'warning');
  }
  checkAuthReady(); // <--- 關鍵：這裡要加
}
// ------ 登入/登出 UI 狀態控制 ------
function checkAuthReady() {
  // 若已登入且 API 設定完成，則解鎖分析欄位
  if (state.gapiReady && state.gisReady) {
    if (!state.accessToken) {
      ui.authorizeButton.classList.remove('hidden');
      ui.userProfile.classList.add('hidden');
      ui.appContainer.classList.add('locked');
      ui.analysisSection.classList.add('locked');
    } else {
      ui.authorizeButton.classList.add('hidden');
      ui.userProfile.classList.remove('hidden');
      ui.appContainer.classList.remove('locked');
      if (state.isApiReady) {
        ui.analysisSection.classList.remove('locked');
      } else {
        ui.analysisSection.classList.add('locked');
      }
    }
  }
}
function handleAuthClick() {
  if (state.tokenClient) {
    state.tokenClient.requestAccessToken();
  } else {
    alert('Google Token Client 尚未初始化，請稍後再試。');
  }
}

function gisInCallback(response) {
  if (response && response.access_token) {
    state.accessToken = response.access_token;
    checkAuthReady();
    // 這裡可以加載 user profile 等
  }
}

function handleSignOutClick() {
  state.accessToken = null;
  state.userProfile = null;
  checkAuthReady();
}
// ------ 欄位驗證 ------
function validateFields() {
  let valid = false;
  const fields = ['industry', 'sector', 'product', 'company'];
  for (let id of fields) {
    const val = document.getElementById(id).value.trim();
    if (val) valid = true;
  }
  if (!valid) {
    showAlert('需要輸入', '請至少填寫一個分析欄位（產業、行業、產品、公司）。', 'warning');
  }
  return valid;
}

// ------ 取得查詢參數 ------
function getSearchContext() {
  return {
    topic: document.getElementById('topic')?.value.trim() || '',
    country: document.getElementById('country').value,
    language: document.getElementById('language').value,
    industry: document.getElementById('industry').value.trim(),
    sector: document.getElementById('sector').value.trim(),
    product: document.getElementById('product').value.trim(),
    company: document.getElementById('company').value.trim(),
    businessModel: document.querySelector('input[name="business-model"]:checked').value,
    targetAudience: document.getElementById('target-audience').value.trim()
  };
}

// ------ 主流程 ------
async function startInitialAnalysis() {
  // 新分析前重置排序狀態
  keywordsSortKey = 'volume';
  keywordsSortOrder = 'desc';
  competitorsSortKey = '';
  competitorsSortOrder = 'desc';

  if (!validateFields()) return;
  ui.startAnalysisBtn.disabled = true;
  ui.analyzeSelectedBtn.disabled = true;

  if (!state.isApiReady) { showAlert('API 尚未就緒', '請先儲存您的 API 設定。', 'error'); ui.startAnalysisBtn.disabled = false; ui.analyzeSelectedBtn.disabled = false; return; }

  ui.loadingIndicator.classList.remove('hidden');
  ui.spinner.classList.remove('hidden');
  ui.loadingStatus.textContent = '步驟 1/2: 正在生成關鍵字與競爭對手名單...';
  ui.resultsContainer.classList.add('hidden');
  ui.resultsActions.classList.add('hidden');
  ui.competitorSelectPanel.classList.add('hidden');
  try {
    const keywordsResponse = await getAiKeywordAnalysis();
    state.currentResults = { keywords: keywordsResponse.keywords || [] };
    renderPartialResults('keywords');
    // 產生競爭對手名稱
    let aiPromises = [];
    if (state.apiKeys.gemini) aiPromises.push(getAiCompetitorNames_Gemini().catch(e => { showAlert('Gemini 失敗', 'Gemini未取得競爭對手'); return []; }));
    if (state.apiKeys.monica) aiPromises.push(getAiCompetitorNames_Monica().catch(e => { showAlert('Monica 失敗', 'Monica未取得競爭對手'); return []; }));
    if (!aiPromises.length) { showAlert('錯誤', '請至少填寫一組AI API金鑰', 'warning'); return; }
    const aiResults = await Promise.all(aiPromises);
    let mergedNames = [];
    if (aiResults[0]) aiResults[0].forEach(n => mergedNames.push({ name: n, source: state.apiKeys.gemini ? 'Gemini' : '' }));
    if (aiResults[1]) aiResults[1].forEach(n => {
      let idx = mergedNames.findIndex(i => i.name === n);
      if (idx === -1) mergedNames.push({ name: n, source: 'Monica' });
      else mergedNames[idx].source = mergedNames[idx].source === 'Gemini' ? '兩者' : 'Monica';
    });
    if (!mergedNames.length) { showAlert('提示', '查無競爭對手，請調整條件。', 'info'); return; }
    state.initialCompetitorNames = mergedNames;
    showCompetitorSelectPanel(mergedNames);
    ui.loadingStatus.textContent = '請在下方勾選競爭對手並按「進行分析」';
    ui.spinner.classList.add('hidden');
  } catch (error) {
    showAlert('分析失敗', '步驟一失敗: ' + error?.message, 'error');
    ui.spinner.classList.add('hidden');
  } finally {
    ui.startAnalysisBtn.disabled = false;
    ui.analyzeSelectedBtn.disabled = false;
  }
}
async function analyzeCheckedCompetitors() {
  ui.startAnalysisBtn.disabled = true;
  ui.analyzeSelectedBtn.disabled = true;

  const selected = Array.from(document.querySelectorAll('.competitor-checkbox'))
    .filter(cb => cb.checked)
    .map(cb => cb.value);
  if (!selected.length) { showAlert("未選擇", "請至少勾選一個競爭對手。", "warning"); ui.startAnalysisBtn.disabled = false; ui.analyzeSelectedBtn.disabled = false; return; }
  ui.loadingIndicator.classList.remove('hidden');
  ui.spinner.classList.remove('hidden');
  ui.loadingStatus.textContent = "步驟 2/2: 正在取得競爭對手細部資料...";
  ui.resultsContainer.classList.add('hidden');
  ui.resultsActions.classList.add('hidden');
  try {
    let aiPromises = [];
    if (state.apiKeys.gemini) aiPromises.push(getAiCompetitorDetails_Gemini(selected).catch(e => { showAlert('Gemini細節失敗',e.message,'warning'); return []; }));
    if (state.apiKeys.monica) aiPromises.push(getAiCompetitorDetails_Monica(selected).catch(e => { showAlert('Monica細節失敗',e.message,'warning'); return []; }));
    if (!aiPromises.length) { showAlert('錯誤','請至少填寫一組AI API金鑰','warning'); return; }
    const aiResults = await Promise.all(aiPromises);
    let allDetails = [];
    if (aiResults[0]) aiResults[0].forEach(item => allDetails.push({ ...item, aiSource: state.apiKeys.gemini ? 'Gemini' : '' }));
    if (aiResults[1]) aiResults[1].forEach(item => {
      let existing = allDetails.find(d => d.brandName === item.brandName);
      if (existing) {
        existing.aiSource = existing.aiSource === 'Gemini' ? '兩者' : 'Monica';
        for (const key in item) if (item[key] && !existing[key]) existing[key] = item[key];
      } else {
        allDetails.push({ ...item, aiSource: 'Monica' });
      }
    });
    state.currentResults.competitors = allDetails;
    renderPartialResults('competitors');
    ui.resultsContainer.classList.remove('hidden');
    ui.resultsActions.classList.remove('hidden');
    showAlert('分析完成', '競爭對手詳細資料已取得。', 'success');
  } catch (e) {
    showAlert('分析失敗', 'AI分析競爭對手細節失敗。', 'error');
  } finally {
    ui.spinner.classList.add('hidden');
    ui.startAnalysisBtn.disabled = false;
    ui.analyzeSelectedBtn.disabled = false;
  }
}

// ------ 表格排序狀態 ------
let keywordsSortKey = 'volume';
let keywordsSortOrder = 'desc';
let competitorsSortKey = '';
let competitorsSortOrder = 'desc';

// 強化排序資料型態一致性
function sortByKey(arr, key, order = 'desc', isNumber = false) {
  return [...arr].sort((a, b) => {
    let aVal = a[key] || '';
    let bVal = b[key] || '';
    if (key === 'volume') {
      const volumeMap = {'高': 3, '中': 2, '低': 1};
      aVal = volumeMap[aVal] !== undefined ? volumeMap[aVal] : (parseFloat(aVal) || 0);
      bVal = volumeMap[bVal] !== undefined ? volumeMap[bVal] : (parseFloat(bVal) || 0);
      isNumber = true;
    }
    if(isNumber) {
      aVal = parseFloat(aVal) || 0;
      bVal = parseFloat(bVal) || 0;
    }
    if(aVal < bVal) return order === 'asc' ? -1 : 1;
    if(aVal > bVal) return order === 'asc' ? 1 : -1;
    return 0;
  });
}

// 排序事件 for 關鍵字
window.sortKeywordsTable = function(key) {
  if (keywordsSortKey === key) {
    keywordsSortOrder = keywordsSortOrder === 'asc' ? 'desc' : 'asc';
  } else {
    keywordsSortKey = key;
    keywordsSortOrder = 'desc';
  }
  renderPartialResults('keywords');
};

// 排序事件 for 競爭對手
window.sortCompetitorsTable = function(key) {
  if (competitorsSortKey === key) {
    competitorsSortOrder = competitorsSortOrder === 'asc' ? 'desc' : 'asc';
  } else {
    competitorsSortKey = key;
    competitorsSortOrder = 'desc';
  }
  renderPartialResults('competitors');
};

// ------ 結果渲染 ------
function renderPartialResults(type) {
  if (type === 'keywords') {
    const panel = document.getElementById('keywords-result-panel');
    const keywords = state.currentResults.keywords || [];
    if (!keywords.length) {
      panel.innerHTML = '<div class="text-gray-500">查無關鍵字資料。</div>';
      return;
    }
    const sortedKeywords = sortByKey(
      keywords,
      keywordsSortKey,
      keywordsSortOrder,
      keywordsSortKey === 'volume'
    );
    panel.innerHTML = `<table class="w-full text-left text-sm">
      <thead class="bg-gray-900">
        <tr class="border-b border-techprimary/30">
          <th class="py-2 px-2 cursor-pointer" onclick="sortKeywordsTable('keyword')">
            關鍵字${keywordsSortKey==='keyword'? (keywordsSortOrder==='asc'?' ▲':' ▼') : ''}
          </th>
          <th class="cursor-pointer" onclick="sortKeywordsTable('volume')">
            搜尋量級${keywordsSortKey==='volume'? (keywordsSortOrder==='asc'?' ▲':' ▼') : ''}
          </th>
          <th class="cursor-pointer" onclick="sortKeywordsTable('type')">
            類型${keywordsSortKey==='type'? (keywordsSortOrder==='asc'?' ▲':' ▼') : ''}
          </th>
        </tr>
      </thead>
      <tbody>
        ${sortedKeywords.map(k => 
          `<tr class="border-b border-techprimary/20">
            <td class="py-2 px-2">${k.keyword}</td>
            <td>${k.volume}</td>
            <td>${k.type}</td>
          </tr>`
        ).join('')}
      </tbody>
    </table>`;
    return;
  }

  if (type === 'competitors') {
    const competitorsPanel = document.getElementById('competitors-result-panel');
    const competitors = state.currentResults.competitors || [];
    if (!competitors.length) {
      competitorsPanel.innerHTML = '<div class="text-gray-500">查無競爭對手資料。</div>';
    } else {
      const sortedCompetitors = competitorsSortKey
        ? sortByKey(competitors, competitorsSortKey, competitorsSortOrder)
        : competitors;
      competitorsPanel.innerHTML = `<table class="w-full text-sm">
        <thead>
          <tr>
            <th class="cursor-pointer" onclick="sortCompetitorsTable('brandName')">
              品牌名稱${competitorsSortKey==='brandName'? (competitorsSortOrder==='asc'?' ▲':' ▼') : ''}
            </th>
            <th class="cursor-pointer" onclick="sortCompetitorsTable('country')">
              國家${competitorsSortKey==='country'? (competitorsSortOrder==='asc'?' ▲':' ▼') : ''}
            </th>
            <th class="cursor-pointer" onclick="sortCompetitorsTable('websiteUrl')">
              網站${competitorsSortKey==='websiteUrl'? (competitorsSortOrder==='asc'?' ▲':' ▼') : ''}
            </th>
            <th class="cursor-pointer" onclick="sortCompetitorsTable('companyType')">
              公司類型${competitorsSortKey==='companyType'? (competitorsSortOrder==='asc'?' ▲':' ▼') : ''}
            </th>
            <th class="cursor-pointer" onclick="sortCompetitorsTable('linkedinUrl')">
              LinkedIn${competitorsSortKey==='linkedinUrl'? (competitorsSortOrder==='asc'?' ▲':' ▼') : ''}
            </th>
            <th class="cursor-pointer" onclick="sortCompetitorsTable('summary')">
              簡介${competitorsSortKey==='summary'? (competitorsSortOrder==='asc'?' ▲':' ▼') : ''}
            </th>
          </tr>
        </thead>
        <tbody>
          ${sortedCompetitors.map(c =>
            `<tr>
              <td>${c.brandName || '-'}</td>
              <td>${c.country || '-'}</td>
              <td>${c.websiteUrl ? `<a href="${c.websiteUrl}" target="_blank">${c.websiteUrl}</a>` : '-'}</td>
              <td>${c.companyType || '-'}</td>
              <td>${c.linkedinUrl ? `<a href="${c.linkedinUrl}" target="_blank">${c.linkedinUrl}</a>` : '-'}</td>
              <td>${c.summary || '-'}</td>
            </tr>`
          ).join('')}
        </tbody>
      </table>`;
    }
    // LinkedIn 區塊維持原本寫法
    const linkedinPanel = document.getElementById('linkedin-result-panel');
    if (!competitors.length) {
      linkedinPanel.innerHTML = '<div class="text-gray-500">查無LinkedIn資料。</div>';
    } else {
      linkedinPanel.innerHTML = competitors.map(c =>
        `<div class="p-4 rounded-xl bg-gradient-to-br from-techbg to-techpanel shadow-lg border border-techprimary/20 mb-4">
          <div class="flex gap-3 items-center">
            <span class="inline-block w-2 h-2 rounded-full bg-techaccent animate-pulse"></span>
            <span class="font-bold text-lg text-techaccent">${c.brandName}</span>
            <span class="text-xs bg-techprimary/20 text-techprimary px-2 py-0.5 rounded ml-2">${c.aiSource || ''}</span>
          </div>
          <p class="mt-1 text-gray-200">公司類型：${c.companyType || '-'}</p>
          <a href="${c.linkedinUrl}" target="_blank" class="block text-techaccent underline hover:text-techprimary mt-1 transition">${c.linkedinUrl||'-'}</a>
          <div class="mt-2 text-sm text-techprimary/60">
            股號：${c.stockCode || '-'}<br/>
            郵遞區號：${c.zipcode || '-'}
          </div>
        </div>`
      ).join('');
    }
    return;
  }
}

// ------ 匯出與儲存 ------
function exportToExcel() {
  if (!state.currentResults || !state.currentResults.keywords) {
    showAlert("無法匯出", "目前尚未有完整分析結果。", "warning");
    return;
  }
  const wb = XLSX.utils.book_new();
  // 關鍵字
  const keywordsSheet = XLSX.utils.json_to_sheet(state.currentResults.keywords || []);
  XLSX.utils.book_append_sheet(wb, keywordsSheet, "A_關鍵字分析");
  // 競爭對手網站
  const competitorsSheetData = (state.currentResults.competitors || []).map(c => ({
      '品牌名稱': c.brandName || '-',
      '業務摘要': c.summary || '-',
      '網站': c.websiteUrl || '-',
      '公司類型': c.companyType || '-',
      '股票代號': c.stockCode || '-',
      '郵遞區號': c.zipcode || '-',
      'AI來源': c.aiSource || '-'
  }));
  const competitorsSheet = XLSX.utils.json_to_sheet(competitorsSheetData);
  XLSX.utils.book_append_sheet(wb, competitorsSheet, "B_競爭對手網站");
  // LinkedIn
  const linkedinSheetData = (state.currentResults.competitors || []).map(c => ({
      '品牌名稱': c.brandName || '-',
      '公司類型': c.companyType || '-',
      'LinkedIn': c.linkedinUrl || '-',
      '股票代號': c.stockCode || '-',
      '郵遞區號': c.zipcode || '-',
      'AI來源': c.aiSource || '-'
  }));
  const linkedinSheet = XLSX.utils.json_to_sheet(linkedinSheetData);
  XLSX.utils.book_append_sheet(wb, linkedinSheet, "C_LinkedIn分析");
  const context = getSearchContext();
  XLSX.writeFile(wb, `${context.topic || '分析'}_Analysis.xlsx`);
}
// ... 其他 function (如 exportToExcel) ...

async function saveAnalysisToDrive() {
  if (!state.accessToken) {
    showAlert('未登入', '請先登入 Google 帳戶。', 'error');
    return;
  }
  if (!state.currentResults) {
    showAlert('尚無分析結果', '請先執行分析，產生資料。', 'warning');
    return;
  }
  // 產生儲存內容 (你可根據需求改為 JSON、CSV等)
  const fileContent = JSON.stringify(state.currentResults, null, 2);
  const blob = new Blob([fileContent], {type: 'application/json'});
  const metadata = {
    name: `分析結果_${new Date().toISOString().slice(0,19).replace(/[-T:]/g, "")}.json`,
    mimeType: 'application/json',
    parents: state.driveFolderId ? [state.driveFolderId] : undefined
  };

  const form = new FormData();
  form.append('metadata', new Blob([JSON.stringify(metadata)], {type: 'application/json'}));
  form.append('file', blob);

  const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
    method: 'POST',
    headers: new Headers({ 'Authorization': 'Bearer ' + state.accessToken }),
    body: form
  });

  if (response.ok) {
    showAlert('成功', '分析結果已上傳到 Google Drive。', 'success');
  } else {
    showAlert('存檔失敗', (await response.json()).error?.message || '發生未知錯誤', 'error');
  }
}
// --------- 狀態管理 ---------
const state = {
  apiKeys: {
    gemini: '', // 請填入你的 Gemini API Key
    monica: ''  // 請填入你的 Monica API Key
  }
};

// --------- Gemini 串接 ---------
async function getAiKeywordAnalysis_Gemini(context) {
  const prompt = `
    根據以下分析條件，列出 30 組高相關性的關鍵字（依相關性由高到低排序），格式為 [{"keyword":"xxx", "volume":"高/中/低", "type":"xxx"}]，只回傳 JSON 陣列即可，且必須依相關性排序：
    條件：${JSON.stringify(context)}
  `;
  const apiKey = state.apiKeys.gemini;
  if (!apiKey) throw new Error('請先填寫 Gemini API Key');
  const url = "https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=" + apiKey;
  const body = {
    contents: [{ parts: [{ text: prompt }] }]
  };
  const res = await fetch(url, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(body)
  });
  const data = await res.json();
  let keywords = [];
  try {
    const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
    const match = text.match(/\[.*\]/s);
    if (match) {
      keywords = JSON.parse(match[0]).map(obj => ({
        ...obj,
        source: 'Gemini'
      }));
    }
  } catch (e) {
    throw new Error('Gemini 回傳格式解析失敗');
  }
  return keywords;
}

// --------- Monica 串接 ---------
async function getAiKeywordAnalysis_Monica(context) {
  const prompt = `
    依據這些條件，列出30個高相關性的關鍵字（依相關性由高到低排序），回傳格式為 [{"keyword":"xxx","volume":"高/中/低","type":"xxx"}]，只回傳 JSON 陣列即可，且必須依相關性排序：
    條件：${JSON.stringify(context)}
  `;
  const apiKey = state.apiKeys.monica;
  if (!apiKey) throw new Error('請先填寫 Monica API Key');
  const url = "https://api.monica.im/v1/chat/completions";
  const body = {
    model: "monica-16k",
    messages: [{ role: "user", content: prompt }],
    stream: false
  };
  const res = await fetch(url, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": "Bearer " + apiKey
    },
    body: JSON.stringify(body)
  });
  const data = await res.json();
  let keywords = [];
  try {
    const text = data.choices?.[0]?.message?.content || '';
    const match = text.match(/\[.*\]/s);
    if (match) {
      keywords = JSON.parse(match[0]).map(obj => ({
        ...obj,
        source: 'Monica'
      }));
    }
  } catch (e) {
    throw new Error('Monica 回傳格式解析失敗');
  }
  return keywords;
}

// --------- 合併 & 去重 ---------
function mergeAndDedupKeywords(arrays) {
  const map = new Map();
  arrays.flat().forEach(obj => {
    const key = obj.keyword.trim();
    if (!map.has(key)) {
      map.set(key, obj);
    } else {
      // 標註多來源
      const exist = map.get(key);
      if (exist.source && obj.source && !exist.source.includes(obj.source)) {
        exist.source += `,${obj.source}`;
      }
    }
  });
  // 保持原排序
  return Array.from(map.values());
}

// --------- 並行呼叫兩AI ---------
async function getAiKeywordAnalysisBoth(context) {
  const apis = [];
  if (state.apiKeys.gemini) apis.push(getAiKeywordAnalysis_Gemini(context));
  if (state.apiKeys.monica) apis.push(getAiKeywordAnalysis_Monica(context));
  if (apis.length === 0) throw new Error("請先填寫至少一組 AI API Key");
  const results = await Promise.all(apis);
  const allKeywords = mergeAndDedupKeywords(results);
  return {
    all: allKeywords,
    gemini: results[0] || [],
    monica: results[1] || []
  };
}

// --------- 顯示工具 ---------
function renderKeywords(keywordList) {
  if (!keywordList.length) return "<li>無資料</li>";
  return keywordList.map((obj, idx) =>
    `<li>${idx + 1}. ${obj.keyword}（熱度：${obj.volume}，類型：${obj.type}，來源：${obj.source}）</li>`
  ).join('');
}

// --------- 主流程：取得並顯示 ---------
async function showKeywords(context) {
  try {
    document.getElementById('keywords-list').innerHTML = '分析中...';
    const result = await getAiKeywordAnalysisBoth(context);
    document.getElementById('keywords-list').innerHTML =
      '<ul>' + renderKeywords(result.all) + '</ul>';
    // 如需分開顯示 gemini/monica 結果，也可用 result.gemini, result.monica
  } catch (e) {
    document.getElementById('keywords-list').innerHTML =
      `<span style="color:red">AI 關鍵字分析失敗：${e.message}</span>`;
  }
}
// --------- AI 關鍵字分析函式區塊 PATCH ---------
async function getAiKeywordAnalysis_Gemini(context) {
  const prompt = `
    根據以下分析條件，列出 30 組高相關性的關鍵字（依相關性由高到低排序），格式為 [{"keyword":"xxx", "volume":"高/中/低", "type":"xxx"}]，只回傳 JSON 陣列即可，且必須依相關性排序：
    條件：${JSON.stringify(context)}
  `;
  const apiKey = state.apiKeys.gemini;
  if (!apiKey) throw new Error('請先填寫 Gemini API Key');
  const url = "https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=" + apiKey;
  const body = {
    contents: [{ parts: [{ text: prompt }] }]
  };
  const res = await fetch(url, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(body)
  });
  const data = await res.json();
  let keywords = [];
  try {
    const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
    const match = text.match(/\[.*\]/s);
    if (match) {
      keywords = JSON.parse(match[0]).map(obj => ({
        ...obj,
        source: 'Gemini'
      }));
    }
  } catch (e) {
    throw new Error('Gemini 回傳格式解析失敗');
  }
  return keywords;
}

async function getAiKeywordAnalysis_Monica(context) {
  const prompt = `
    依據這些條件，列出30個高相關性的關鍵字（依相關性由高到低排序），回傳格式為 [{"keyword":"xxx","volume":"高/中/低","type":"xxx"}]，只回傳 JSON 陣列即可，且必須依相關性排序：
    條件：${JSON.stringify(context)}
  `;
  const apiKey = state.apiKeys.monica;
  if (!apiKey) throw new Error('請先填寫 Monica API Key');
  const url = "https://api.monica.im/v1/chat/completions";
  const body = {
    model: "monica-16k",
    messages: [{ role: "user", content: prompt }],
    stream: false
  };
  const res = await fetch(url, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": "Bearer " + apiKey
    },
    body: JSON.stringify(body)
  });
  const data = await res.json();
  let keywords = [];
  try {
    const text = data.choices?.[0]?.message?.content || '';
    const match = text.match(/\[.*\]/s);
    if (match) {
      keywords = JSON.parse(match[0]).map(obj => ({
        ...obj,
        source: 'Monica'
      }));
    }
  } catch (e) {
    throw new Error('Monica 回傳格式解析失敗');
  }
  return keywords;
}

function mergeAndDedupKeywords(arrays) {
  const map = new Map();
  arrays.flat().forEach(obj => {
    const key = obj.keyword.trim();
    if (!map.has(key)) {
      map.set(key, obj);
    } else {
      const exist = map.get(key);
      if (exist.source && obj.source && !exist.source.includes(obj.source)) {
        exist.source += `,${obj.source}`;
      }
    }
  });
  return Array.from(map.values());
}

async function getAiKeywordAnalysisBoth(context) {
  const apis = [];
  if (state.apiKeys.gemini) apis.push(getAiKeywordAnalysis_Gemini(context));
  if (state.apiKeys.monica) apis.push(getAiKeywordAnalysis_Monica(context));
  if (apis.length === 0) throw new Error("請先填寫至少一組 AI API Key");
  const results = await Promise.all(apis);
  const allKeywords = mergeAndDedupKeywords(results);
  return {
    all: allKeywords,
    gemini: results[0] || [],
    monica: results[1] || []
  };
}

// ------ 主程式預期的函式名 PATCH ------
async function getAiKeywordAnalysis() {
  const context = getSearchContext();
  const result = await getAiKeywordAnalysisBoth(context);
  return { keywords: result.all };
}

// ------ 顯示工具（如需單獨顯示用） ------
function renderKeywords(keywordList) {
  if (!keywordList.length) return "<li>無資料</li>";
  return keywordList.map((obj, idx) =>
    `<li>${idx + 1}. ${obj.keyword}（熱度：${obj.volume}，類型：${obj.type}，來源：${obj.source}）</li>`
  ).join('');
}

// 如果你想測試可加這行：
// showKeywords(getSearchContext());
// --------- 用法範例 ---------
// 頁面需有 <div id="keywords-list"></div>
// const context = { topic: "AI行銷工具", otherInfo: "B2B產業" };
// showKeywords(context);

// ...（其餘如 Google Drive、showAlert 等維持原本即可）
</script>
</body>
</html>
