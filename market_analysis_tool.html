<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>市場情資與競品分析平台</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        /* Custom Styles for a Polished Look */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        .tab.active { border-color: #4f46e5; background-color: #eef2ff; color: #4338ca; }
        .panel { display: none; }
        .panel.active { display: block; animation: fadeIn 0.5s ease; }
        .locked { opacity: 0.5; pointer-events: none; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #4f46e5; animation: spin 1s ease infinite; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Header -->
    <header class="bg-white shadow-md">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-gray-800">市場情資與競品分析平台</h1>
            <div id="auth-container">
                <button id="authorize_button" class="hidden bg-indigo-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-indigo-700 transition">使用 Google 帳戶登入</button>
                <div id="user-profile" class="hidden items-center gap-3">
                    <img id="user-avatar" class="w-10 h-10 rounded-full" src="" alt="User Avatar">
                    <span id="user-name" class="font-semibold text-gray-700"></span>
                    <button id="signout_button" class="text-sm text-gray-500 hover:text-gray-800">登出</button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-6 py-8">
        <!-- App Container -->
        <div id="app-container" class="locked">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                
                <!-- Left Panel: Controls & Settings -->
                <div class="lg:col-span-1 space-y-6">
                    <!-- API Settings -->
                    <section id="settings-section" class="bg-white p-6 rounded-lg shadow-lg">
                        <h2 class="text-xl font-bold mb-4">API & 應用程式設定</h2>
                        <div class="space-y-4">
                            <div>
                                <label for="google-api-key" class="block text-sm font-medium text-gray-700">Google API 金鑰</label>
                                <input type="password" id="google-api-key" class="mt-1 w-full p-2 border rounded-md" placeholder="請輸入您的 Google API 金鑰">
                            </div>
                            <div>
                                <label for="search-engine-id" class="block text-sm font-medium text-gray-700">可程式化搜尋引擎 ID (CX)</label>
                                <input type="text" id="search-engine-id" class="mt-1 w-full p-2 border rounded-md" placeholder="請輸入您的 CX ID">
                            </div>
                             <div>
                                <label for="ai-provider" class="block text-sm font-medium text-gray-700">AI 模型提供商</label>
                                <select id="ai-provider" class="mt-1 w-full p-2 border rounded-md">
                                    <option value="gemini">Google Gemini</option>
                                    <option value="monica">Monica (Coming Soon)</option>
                                </select>
                            </div>
                            <div>
                                <label for="ai-api-key" class="block text-sm font-medium text-gray-700">AI API 金鑰</label>
                                <input type="password" id="ai-api-key" class="mt-1 w-full p-2 border rounded-md" placeholder="請輸入您的 AI API 金鑰">
                            </div>
                            <button id="save-settings-btn" class="w-full bg-green-600 text-white font-bold py-2 rounded-lg hover:bg-green-700">儲存並啟用設定</button>
                        </div>
                    </section>
                    
                    <!-- Analysis Input -->
                    <section id="analysis-input-section" class="bg-white p-6 rounded-lg shadow-lg locked">
                         <h2 class="text-xl font-bold mb-4">分析目標</h2>
                         <div class="space-y-4">
                             <div>
                                <label for="core-keyword" class="block text-sm font-medium text-gray-700">行業/品牌/產品關鍵字</label>
                                <input type="text" id="core-keyword" class="mt-1 w-full p-2 border rounded-md" placeholder="例如：電動車, SaaS">
                            </div>
                            <div>
                                <label for="target-market" class="block text-sm font-medium text-gray-700">目標市場</label>
                                <select id="target-market" class="mt-1 w-full p-2 border rounded-md">
                                    <option value="us|en">美國 (English)</option>
                                    <option value="jp|ja">日本 (日本語)</option>
                                    <option value="tw|zh-TW">台灣 (繁體中文)</option>
                                    <option value="de|de">德國 (Deutsch)</option>
                                    <option value="fr|fr">法國 (Français)</option>
                                </select>
                            </div>
                             <div>
                                <label class="block text-sm font-medium text-gray-700">商業模式</label>
                                <div class="mt-2 space-x-4">
                                    <label><input type="radio" name="business-model" value="B2C" checked> B2C</label>
                                    <label><input type="radio" name="business-model" value="B2B"> B2B</label>
                                </div>
                            </div>
                            <button id="start-analysis-btn" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg hover:bg-indigo-700 transition">開始分析</button>
                         </div>
                    </section>
                </div>

                <!-- Right Panel: Results & History -->
                <div class="lg:col-span-2 space-y-6">
                    <div class="bg-white rounded-lg shadow-lg">
                        <div class="flex border-b">
                            <button data-tab="results" class="tab-btn tab active flex-1 p-4 font-semibold">分析結果</button>
                            <button data-tab="history" class="tab-btn tab flex-1 p-4 font-semibold">歷史紀錄</button>
                        </div>

                        <!-- Results Panel -->
                        <div id="results-panel" class="panel active p-6">
                           <div id="results-content" class="min-h-[400px]">
                                <div id="loading-indicator" class="hidden flex flex-col items-center justify-center h-full">
                                    <div class="spinner"></div>
                                    <p id="loading-status" class="mt-4 text-gray-600 font-medium">正在準備分析...</p>
                                </div>
                               <div id="results-tabs-container"></div>
                           </div>
                           <div id="results-actions" class="hidden mt-4 flex gap-4">
                               <button id="save-analysis-btn" class="flex-1 bg-blue-600 text-white font-bold py-2 rounded-lg hover:bg-blue-700">儲存本次分析</button>
                               <button id="export-excel-btn" class="flex-1 bg-gray-700 text-white font-bold py-2 rounded-lg hover:bg-gray-800">匯出為 Excel</button>
                           </div>
                        </div>

                        <!-- History Panel -->
                        <div id="history-panel" class="panel p-6 min-h-[400px]">
                            <div id="history-list" class="space-y-4">
                                <p class="text-gray-500">沒有歷史紀錄。</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </main>
<script>
// --- Client-Side Application Logic ---

// --- 1. State and Configuration ---
const state = {
    gapiReady: false,
    gisReady: false,
    tokenClient: null,
    accessToken: null,
    userProfile: null,
    driveFolderId: null,
    apiKeys: {
        google: null,
        searchEngineId: null,
        aiProvider: 'gemini',
        ai: null
    },
    isApiReady: false,
    currentResults: null
};

const CONFIG = {
    // IMPORTANT: Replace with your actual Google Cloud Project's Client ID
    CLIENT_ID: "733619441496-5gigdpkv42k84no3q5vvh93ths1e8u29.apps.googleusercontent.com",
    // Scopes requested by the application
    SCOPES: "https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/userinfo.profile https://www.googleapis.com/auth/userinfo.email",
    DRIVE_FOLDER_NAME: "MarketingAnalysisTool_Data"
};

// --- 2. Element References ---
const ui = {
    authorizeButton: document.getElementById('authorize_button'),
    signOutButton: document.getElementById('signout_button'),
    authContainer: document.getElementById('auth-container'),
    userProfile: document.getElementById('user-profile'),
    appContainer: document.getElementById('app-container'),
    settingsSection: document.getElementById('settings-section'),
    analysisSection: document.getElementById('analysis-input-section'),
    saveSettingsBtn: document.getElementById('save-settings-btn'),
    startAnalysisBtn: document.getElementById('start-analysis-btn'),
    loadingIndicator: document.getElementById('loading-indicator'),
    loadingStatus: document.getElementById('loading-status'),
    resultsContainer: document.getElementById('results-tabs-container'),
    resultsActions: document.getElementById('results-actions'),
    historyList: document.getElementById('history-list'),
};

// --- 3. Initialization ---
window.onload = () => {
    // Load Google's API client and Identity Services scripts
    gapi.load('client', gapiLoaded);
    const gisScript = document.createElement('script');
    gisScript.src = 'https://accounts.google.com/gsi/client';
    gisScript.async = true;
    gisScript.defer = true;
    gisScript.onload = gisLoaded;
    document.body.appendChild(gisScript);

    // Setup event listeners
    setupEventListeners();
};

function setupEventListeners() {
    ui.authorizeButton.onclick = handleAuthClick;
    ui.signOutButton.onclick = handleSignOutClick;
    ui.saveSettingsBtn.onclick = handleSaveSettings;
    ui.startAnalysisBtn.onclick = startAnalysisWorkflow;

    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const tab = btn.dataset.tab;
            // Manage button styles
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            // Manage panel visibility
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            document.getElementById(`${tab}-panel`).classList.add('active');
        });
    });
    
    // Delegated event listeners for dynamically created content
    document.getElementById('history-list').addEventListener('click', handleHistoryAction);
    document.getElementById('results-actions').addEventListener('click', handleResultAction);
}


// --- 4. Authentication & Authorization ---
function gapiLoaded() {
    gapi.client.init({}).then(() => {
        state.gapiReady = true;
        maybeEnableAuthButton();
    });
}

function gisLoaded() {
    state.tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CONFIG.CLIENT_ID,
        scope: CONFIG.SCOPES,
        callback: gisInCallback,
    });
    state.gisReady = true;
    maybeEnableAuthButton();
}

function maybeEnableAuthButton() {
    if (state.gapiReady && state.gisReady) {
        ui.authorizeButton.classList.remove('hidden');
    }
}

function gisInCallback(resp) {
    if (resp.error) {
        showAlert('Authentication Error', resp.error, 'error');
        return;
    }
    state.accessToken = resp;
    gapi.client.setToken(state.accessToken);
    handleSuccessfulLogin();
}

function handleAuthClick() {
    if (gapi.client.getToken() === null) {
        state.tokenClient.requestAccessToken({ prompt: 'consent' });
    } else {
        state.tokenClient.requestAccessToken({ prompt: '' });
    }
}

async function handleSuccessfulLogin() {
    ui.authorizeButton.classList.add('hidden');
    ui.userProfile.classList.remove('hidden');
    ui.userProfile.classList.add('flex');
    ui.appContainer.classList.remove('locked');

    // Fetch and display user profile
    const profile = await gapi.client.oauth2.userinfo.get();
    state.userProfile = profile.result;
    document.getElementById('user-avatar').src = state.userProfile.picture;
    document.getElementById('user-name').textContent = state.userProfile.given_name || state.userProfile.name;

    // Load saved settings and check for Drive folder
    loadSettingsFromLocalStorage();
    await setupGoogleDrive();
    loadAnalysisHistory();
}

function handleSignOutClick() {
    const token = gapi.client.getToken();
    if (token !== null) {
        google.accounts.oauth2.revoke(token.access_token, () => {
            gapi.client.setToken('');
            state.accessToken = null;
            state.userProfile = null;
            
            ui.userProfile.classList.add('hidden');
            ui.authorizeButton.classList.remove('hidden');
            ui.appContainer.classList.add('locked');
            ui.analysisSection.classList.add('locked');
        });
    }
}


// --- 5. API Settings ---
function handleSaveSettings() {
    const googleApiKey = document.getElementById('google-api-key').value.trim();
    const searchEngineId = document.getElementById('search-engine-id').value.trim();
    const aiProvider = document.getElementById('ai-provider').value;
    const aiApiKey = document.getElementById('ai-api-key').value.trim();
    
    if (!googleApiKey || !searchEngineId || !aiApiKey) {
        showAlert('Information Missing', 'Please fill in all API key and ID fields.', 'warning');
        return;
    }

    state.apiKeys = {
        google: googleApiKey,
        searchEngineId: searchEngineId,
        aiProvider: aiProvider,
        ai: aiApiKey
    };
    
    // "Encrypt" by base64 encoding for simple obfuscation in local storage
    localStorage.setItem('marketingToolApiKeys', btoa(JSON.stringify(state.apiKeys)));
    state.isApiReady = true;
    ui.analysisSection.classList.remove('locked');
    showAlert('Settings Saved', 'API settings have been saved and activated.', 'success');
}

function loadSettingsFromLocalStorage() {
    const savedKeys = localStorage.getItem('marketingToolApiKeys');
    if (savedKeys) {
        try {
            const decodedKeys = JSON.parse(atob(savedKeys));
            state.apiKeys = decodedKeys;
            state.isApiReady = true;
            
            // Populate fields
            document.getElementById('google-api-key').value = state.apiKeys.google || '';
            document.getElementById('search-engine-id').value = state.apiKeys.searchEngineId || '';
            document.getElementById('ai-provider').value = state.apiKeys.aiProvider || 'gemini';
            document.getElementById('ai-api-key').value = state.apiKeys.ai || '';

            ui.analysisSection.classList.remove('locked');
        } catch (e) {
            console.error("Failed to parse saved API keys:", e);
            localStorage.removeItem('marketingToolApiKeys');
        }
    }
}


// --- 6. Google Drive Integration ---
async function setupGoogleDrive() {
    await gapi.client.load('drive', 'v3');
    const response = await gapi.client.drive.files.list({
        q: `name='${CONFIG.DRIVE_FOLDER_NAME}' and mimeType='application/vnd.google-apps.folder' and trashed=false`,
        fields: 'files(id, name)'
    });
    
    if (response.result.files.length > 0) {
        state.driveFolderId = response.result.files[0].id;
    } else {
        const fileMetadata = {
            'name': CONFIG.DRIVE_FOLDER_NAME,
            'mimeType': 'application/vnd.google-apps.folder'
        };
        const createResponse = await gapi.client.drive.files.create({
            resource: fileMetadata,
            fields: 'id'
        });
        state.driveFolderId = createResponse.result.id;
    }
}


// --- 7. Main Analysis Workflow ---
async function startAnalysisWorkflow() {
    if (!state.isApiReady) {
        showAlert('API Not Ready', 'Please save your API settings first.', 'error');
        return;
    }

    const coreKeyword = document.getElementById('core-keyword').value.trim();
    if (!coreKeyword) {
        showAlert('Input Required', 'Please enter an industry, brand, or product keyword.', 'warning');
        return;
    }

    ui.loadingIndicator.classList.remove('hidden');
    ui.resultsContainer.innerHTML = ''; // Clear previous results
    ui.resultsActions.classList.add('hidden');

    try {
        // Step 1: Generate Keywords
        ui.loadingStatus.textContent = '步驟 1/3: 正在生成行業關鍵字...';
        const keywordData = await getAiKeywordAnalysis();
        state.currentResults = { keywords: keywordData.keywords || [] };
        
        // Step 2: Competitor Analysis
        ui.loadingStatus.textContent = '步驟 2/3: 正在搜尋競爭對手...';
        const searchResults = await performGoogleSearch(state.currentResults.keywords);
        
        ui.loadingStatus.textContent = '步驟 3/3: 正在分析競爭對手資訊...';
        const competitorData = await getAiCompetitorAnalysis(searchResults);
        state.currentResults.competitors = competitorData.competitors || [];

        // Step 3: Render results
        renderAnalysisResults(state.currentResults);

    } catch (error) {
        console.error("Analysis failed:", error);
        showAlert('Analysis Failed', `An error occurred: ${error.message}`, 'error');
    } finally {
        ui.loadingIndicator.classList.add('hidden');
    }
}

// --- 8. API Call Functions ---
async function getAiKeywordAnalysis() {
    const marketInfo = document.getElementById('target-market').value.split('|');
    const prompt = `
        You are a senior SEO and market analysis expert specializing in the ${marketInfo[0]} market.
        Please generate a detailed keyword analysis report based on the following criteria:
        - Core Topic: "${document.getElementById('core-keyword').value}"
        - Business Model: "${document.querySelector('input[name="business-model"]:checked').value}"
        - Target Language: "${marketInfo[1]}"
        
        Provide 20 relevant keywords, including short-tail, mid-tail, and long-tail variations. For each keyword, assess its "Search Volume Level" (High, Medium, Low) and "Keyword Type" (e.g., Brand, Product, Comparison, Question, Informational).
        
        Return the response strictly in the following JSON format:
        { "keywords": [{ "keyword": "...", "volume": "High", "type": "Product" }, ...] }`;

    const response = await callGeminiAPI(prompt);
    return JSON.parse(response);
}

async function performGoogleSearch(keywords) {
    if (!keywords || keywords.length === 0) return [];
    
    // Select top 3 high-volume keywords for the query
    const query = keywords.filter(k => k.volume === 'High').slice(0, 3).map(k => k.keyword).join(' OR ');
    if (!query) return [];

    const marketInfo = document.getElementById('target-market').value.split('|');
    
    const response = await gapi.client.request({
        'path': `https://customsearch.googleapis.com/customsearch/v1`,
        'params': {
            'key': state.apiKeys.google,
            'cx': state.apiKeys.searchEngineId,
            'q': query,
            'cr': `country${marketInfo[0].toUpperCase()}`
        }
    });

    return response.result.items || [];
}

async function getAiCompetitorAnalysis(searchResults) {
    if (searchResults.length === 0) return { competitors: [] };

    const context = searchResults.slice(0, 10).map(item => `Title: ${item.title}\nURL: ${item.link}\nSnippet: ${item.snippet}`).join('\n\n');
    
    const prompt = `
        You are a market intelligence analyst. Below are Google search results for "${document.getElementById('core-keyword').value}". Please analyze them and identify the 5 most significant competitors.
        
        For each competitor, complete the following tasks:
        1. Identify their official brand name and main website URL.
        2. Summarize their core business in Traditional Chinese (max 30 words) based on their website snippet.
        3. Find their official LinkedIn company page URL. Return "N/A" if not found.
        4. Classify their business into one of the following types: [SaaS, Hardware Manufacturer, Consulting Service, Retail E-commerce, Agency, Content Platform].
        
        Return the response strictly in the following JSON format:
        { "competitors": [{ "brandName": "...", "websiteUrl": "...", "summary": "...", "linkedinUrl": "...", "companyType": "SaaS" }, ...] }
        
        Context from search results:
        ${context}`;

    const response = await callGeminiAPI(prompt);
    return JSON.parse(response);
}

async function callGeminiAPI(prompt) {
    const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${state.apiKeys.ai}`;
    const response = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            contents: [{ parts: [{ text: prompt }] }]
        })
    });
    if (!response.ok) {
        const errorBody = await response.json();
        throw new Error(`Gemini API Error: ${errorBody.error.message}`);
    }
    const data = await response.json();
    // Clean the response text to get valid JSON
    let text = data.candidates[0].content.parts[0].text;
    text = text.replace(/```json/g, '').replace(/```/g, '').trim();
    return text;
}


// --- 9. Rendering, History & Export ---
function renderAnalysisResults(results) {
    let html = `
        <div class="flex border-b">
            <button class="result-tab-btn tab active flex-1 p-3 font-semibold" data-result-tab="keywords">關鍵字分析</button>
            <button class="result-tab-btn tab flex-1 p-3 font-semibold" data-result-tab="competitors">競爭對手</button>
        </div>
        <div id="keywords-result-panel" class="result-panel active p-4">
            <table class="w-full text-left">
                <thead><tr class="border-b"><th class="py-2">關鍵字</th><th>搜尋量級</th><th>類型</th></tr></thead>
                <tbody>${results.keywords.map(k => `<tr><td class="py-2">${k.keyword}</td><td>${k.volume}</td><td>${k.type}</td></tr>`).join('')}</tbody>
            </table>
        </div>
        <div id="competitors-result-panel" class="result-panel p-4 space-y-4">
             ${results.competitors.map(c => `
                <div class="p-3 border rounded-lg">
                    <p class="font-bold text-lg">${c.brandName}</p>
                    <p class="text-sm text-gray-600">${c.summary}</p>
                    <p class="mt-2 text-sm"><strong>類型:</strong> ${c.companyType}</p>
                    <div class="mt-2 text-sm flex gap-4">
                        <a href="${c.websiteUrl}" target="_blank" class="text-blue-600 hover:underline">網站</a>
                        ${c.linkedinUrl !== 'N/A' ? `<a href="${c.linkedinUrl}" target="_blank" class="text-blue-600 hover:underline">LinkedIn</a>` : ''}
                    </div>
                </div>
             `).join('')}
        </div>
    `;
    ui.resultsContainer.innerHTML = html;
    ui.resultsActions.classList.remove('hidden');

    // Add event listeners for the new result tabs
    document.querySelectorAll('.result-tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const tab = btn.dataset.resultTab;
            document.querySelectorAll('.result-tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            document.querySelectorAll('.result-panel').forEach(p => p.classList.remove('active'));
            document.getElementById(`${tab}-result-panel`).classList.add('active');
        });
    });
}

async function saveAnalysisToDrive() {
    if (!state.currentResults || !state.driveFolderId) return;

    const metadata = {
        name: `${document.getElementById('core-keyword').value.trim()}_${new Date().toISOString()}.json`,
        mimeType: 'application/json',
        parents: [state.driveFolderId]
    };
    const boundary = '-------314159265358979323846';
    const delimiter = `\r\n--${boundary}\r\n`;
    const close_delim = `\r\n--${boundary}--`;

    const multipartRequestBody =
        delimiter +
        'Content-Type: application/json; charset=UTF-8\r\n\r\n' +
        JSON.stringify(metadata) +
        delimiter +
        'Content-Type: application/json\r\n\r\n' +
        JSON.stringify({
            inputs: {
                keyword: document.getElementById('core-keyword').value.trim(),
                market: document.getElementById('target-market').value,
                model: document.querySelector('input[name="business-model"]:checked').value
            },
            results: state.currentResults
        }) +
        close_delim;

    try {
        await gapi.client.request({
            path: '/upload/drive/v3/files',
            method: 'POST',
            params: { uploadType: 'multipart' },
            headers: { 'Content-Type': 'multipart/related; boundary="' + boundary + '"' },
            body: multipartRequestBody
        });
        showAlert('Save Successful', 'Analysis has been saved to your Google Drive.', 'success');
        loadAnalysisHistory(); // Refresh history
    } catch (e) {
        console.error(e);
        showAlert('Save Failed', 'Could not save the analysis to Google Drive.', 'error');
    }
}

async function loadAnalysisHistory() {
    if (!state.driveFolderId) return;

    const response = await gapi.client.drive.files.list({
        q: `'${state.driveFolderId}' in parents and trashed=false`,
        fields: 'files(id, name, createdTime)',
        orderBy: 'createdTime desc'
    });
    
    const files = response.result.files;
    ui.historyList.innerHTML = '';
    if (files && files.length > 0) {
        files.forEach(file => {
            const fileEl = document.createElement('div');
            fileEl.className = 'border p-3 rounded-lg flex justify-between items-center';
            fileEl.innerHTML = `
                <div>
                    <p class="font-semibold">${file.name.replace('.json', '')}</p>
                    <p class="text-sm text-gray-500">Saved on: ${new Date(file.createdTime).toLocaleDateString()}</p>
                </div>
                <div>
                    <button data-id="${file.id}" class="load-history-btn text-sm bg-gray-200 px-3 py-1 rounded hover:bg-gray-300">載入</button>
                </div>
            `;
            ui.historyList.appendChild(fileEl);
        });
    } else {
        ui.historyList.innerHTML = '<p class="text-gray-500">沒有歷史紀錄。</p>';
    }
}

async function handleHistoryAction(e) {
    if (e.target.classList.contains('load-history-btn')) {
        const fileId = e.target.dataset.id;
        try {
            const response = await gapi.client.drive.files.get({
                fileId: fileId,
                alt: 'media'
            });
            const data = response.result;
            state.currentResults = data.results;
            renderAnalysisResults(data.results);
            
            // Switch to results tab
            document.querySelector('.tab-btn[data-tab="results"]').click();
            showAlert('History Loaded', 'Successfully loaded analysis from history.', 'info');
        } catch (error) {
            console.error(error);
            showAlert('Load Failed', 'Could not load the selected history item.', 'error');
        }
    }
}

function handleResultAction(e) {
    if (e.target.id === 'save-analysis-btn') {
        saveAnalysisToDrive();
    } else if (e.target.id === 'export-excel-btn') {
        exportToExcel();
    }
}

function exportToExcel() {
    if (!state.currentResults) return;

    const wb = XLSX.utils.book_new();
    
    // Keywords sheet
    const wsKeywords = XLSX.utils.json_to_sheet(state.currentResults.keywords);
    XLSX.utils.book_append_sheet(wb, wsKeywords, "關鍵字分析");

    // Competitors sheet
    const competitorsForSheet = state.currentResults.competitors.map(c => ({
        '品牌名稱': c.brandName,
        '業務摘要': c.summary,
        '類型': c.companyType,
        '網站': c.websiteUrl,
        'LinkedIn': c.linkedinUrl,
    }));
    const wsCompetitors = XLSX.utils.json_to_sheet(competitorsForSheet);
    XLSX.utils.book_append_sheet(wb, wsCompetitors, "競爭對手分析");
    
    const filename = `${document.getElementById('core-keyword').value.trim()}_Analysis.xlsx`;
    XLSX.writeFile(wb, filename);
}

// --- 10. Utility Functions ---
function showAlert(title, message, type = 'info') {
    const colors = {
        info: 'bg-blue-100 border-blue-500 text-blue-700',
        success: 'bg-green-100 border-green-500 text-green-700',
        warning: 'bg-yellow-100 border-yellow-500 text-yellow-700',
        error: 'bg-red-100 border-red-500 text-red-700',
    };
    const alertEl = document.createElement('div');
    alertEl.className = `p-4 mb-4 rounded-md shadow-lg border-l-4 ${colors[type]}`;
    alertEl.innerHTML = `<div class="flex"><div class="ml-3"><p class="font-bold">${title}</p><p class="text-sm">${message}</p></div></div>`;
    document.getElementById('alert-container').prepend(alertEl);
    setTimeout(() => alertEl.remove(), 5000);
}

</script>
</body>
</html>
